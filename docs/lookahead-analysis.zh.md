# 前视分析（Lookahead Analysis）

本页介绍如何检测策略是否存在前视偏差（Lookahead Bias）。

前视偏差是策略回测中的大敌：它可能非常容易被无意间引入，却极难察觉。由于回测会一次性加载完整的历史数据并计算所有指标，如果策略错误地使用了未来蜡烛的数据，那么回测结果将被严重扭曲。

`lookahead-analysis` 命令需要先准备好历史数据。如何下载数据请参阅[数据下载](data-download.md)。该命令同样支持 FreqAI 策略。

命令的运行逻辑是：通过一系列回测尝试触发策略使用未来数据的行为。它不会直接检查你的策略代码，而是对比“完整回测”与“剪裁回测”指标/信号的差异，以判定是否存在前视偏差。

在执行时，`lookahead-analysis` 会使用回测常见选项，但默认强制以下设置以减少误判：

* `--cache` 强制为 `none`
* `--max-open-trades` 至少等于交易对数量
* `--dry-run-wallet` 设为极大值（10 亿）
* `--stake-amount` 固定为 10000
* 禁用 `--enable-protections`
* 订单类型强制为 `market`（除非使用 `--lookahead-allow-limit-orders`）

## 命令参考

--8<-- "commands/lookahead-analysis.md"

!!! Note
    上述帮助只列出了在常规回测参数基础上新增的部分。

## 利用该工具的意义

许多策略作者在不知情的情况下引入前视偏差，进而得到“夸张、好得不真实”的回测结果。这是因为 Freqtrade 在回测时会预先填充完整的 DataFrame，策略若在逻辑上访问到未来蜡烛，就等同于“作弊”。

`lookahead-analysis` 的目的就是检查策略是否依赖了未来数据。

## 工作原理

1. 首先运行一次完整回测，生成指标与进出场的基线数据。
2. 若策略在该回测中交易次数不足，命令会提示退出（请延长时间范围或选择交易更频繁的区间）。
3. 在基线基础上，命令会对每个入场/出场信号分别进行剪裁回测，比较剪裁结果与基线之间的差异。
4. 最终生成一张结果表，列明哪些信号/指标存在偏差。

## 如何发现并修复偏差？

如果策略本身“太好看”，往往意味着核心逻辑依赖前视数据。一旦移除这些逻辑，策略表现通常会大幅下降。

如果你想挽救某个含偏差的策略：

* 优先修复入场信号，再修复出场信号；
* 若偏差逻辑不是策略核心，有可能保留下其他不含偏差的信号；
* 但多数情况下，只要移除偏差，策略就不再盈利。

## 常见前视偏差示例

* 使用 `shift(-10)` 等操作提前访问未来 10 根蜡烛；
* 在 `populate_*` 函数中使用 `iloc[]` 访问特定行；
* 循环语句若遍历到未来索引，也会导致偏差；
* `.mean()`、`.min()`、`.max()` 等聚合函数若未搭配 `rolling()`，会基于整个 DataFrame 计算，使当前蜡烛“看见”未来数据；
* `ta.MACD(dataframe, 12, 26, 1)`：信号周期为 1 会造成偏差。

## 结果表字段说明

* `filename`：策略文件名
* `strategy`：策略类名
* `has_bias`：是否检测到偏差（`No` 表示安全）
* `total_signals`：检测的信号总数（默认 20）
* `biased_entry_signals`：偏差的入场信号数量
* `biased_exit_signals`：偏差的出场信号数量
* `biased_indicators`：检测到偏差的指标列

若入场信号含偏差，关联的出场信号也常会被标记，因此请先处理入场偏差，再处理出场偏差。

## 注意事项

* 只有在检测到的信号范围内才能判断是否存在偏差。若某些信号在回测区间内从未触发，就无法验证。（这可能导致“假阴性”，即报告无偏差但实际存在。）
* 避免在该命令中启用叠加仓位等特殊选项，以免干扰信号数量统计。
* 限价单结合 `custom_entry_price()`、`custom_exit_price()` 可能出现延迟执行，造成误报。命令默认强制使用市价单；如需启用限价单，请使用 `--lookahead-allow-limit-orders`，但需承担潜在误判风险。
* 结果表中的 `biased_indicators` 会将 FreqAI 在 `set_freqai_targets()` 中定义的标签误判为偏差，可忽略。

只要严格避免上述前视行为，就能显著提升策略回测的可靠性。
