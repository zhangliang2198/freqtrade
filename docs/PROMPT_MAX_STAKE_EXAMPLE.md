# LLM 提示词中的开单额度限制示例

## 概述

本文档展示了开单额度限制功能在 LLM 提示词中的呈现方式。

## 配置示例

在 `llm_deepseek.json` 中配置：

```json
{
    "llm_config": {
        "decision_points": {
            "stake": {
                "enabled": true,
                "min_stake_multiplier": 0.5,
                "max_stake_multiplier": 5.0,
                "max_stake_per_trade": {
                    "mode": "percent",
                    "value": 20
                }
            }
        }
    }
}
```

## Stake 决策点提示词示例

### 场景 1: 百分比模式 - 普通账户

**配置**:
- 模式: percent
- 百分比: 20%
- 可用余额: $1000

**提示词中的呈现**:

```markdown
# 资金状况

**钱包**: 总计$1000.00 | 可用$1000.00 | 使用**0.0%**

## 💰 开单额度限制
每次最大开单额度: 20% 的可用余额 (当前可用: 1000.00, 最大: 200.00)
- **模式**: 百分比 (20%)
- **当前可用**: $1000.00
- **本单最大**: $200.00
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制

---

# 持仓组合
...

# 仓位决策框架

## 决策因子

**因子1: 技术信号强度**（最重要）
- 强烈信号 → 较大仓位
...

**因子3: 资金管理**
- 资金使用率过高 → 强制减小仓位
- 可用余额不足 → 最小倍数或观望
- 资金充裕 → 可根据信号强度放大
- **⚠️ 额度限制**: 本单最大$200.00，超出部分会被自动裁剪
```

### 场景 2: 百分比模式 - 账户分离

**配置**:
- 模式: percent
- 百分比: 20%
- 账户分离已启用
- 多头账户可用: $5000
- 空头账户可用: $3000

**开多单时的提示词**:

```markdown
# 资金状况

**多头账户**: 初始$5000.00 | 可用$5000.00 | 使用**0.0%**
**空头账户**: 初始$3000.00 | 可用$3000.00 | 使用**0.0%**

## 💰 开单额度限制
每次最大开单额度: 20% 的可用余额 (当前可用: 5000.00, 最大: 1000.00)
- **模式**: 百分比 (20%)
- **当前可用**: $5000.00  ← 注意：这是多头账户的可用余额
- **本单最大**: $1000.00
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制
```

**开空单时的提示词**:

```markdown
# 资金状况

**多头账户**: 初始$5000.00 | 可用$5000.00 | 使用**0.0%**
**空头账户**: 初始$3000.00 | 可用$3000.00 | 使用**0.0%**

## 💰 开单额度限制
每次最大开单额度: 20% 的可用余额 (当前可用: 3000.00, 最大: 600.00)
- **模式**: 百分比 (20%)
- **当前可用**: $3000.00  ← 注意：这是空头账户的可用余额
- **本单最大**: $600.00
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制
```

### 场景 3: 固定值模式

**配置**:
- 模式: fixed
- 固定值: $100

**提示词中的呈现**:

```markdown
# 资金状况

**钱包**: 总计$5000.00 | 可用$4500.00 | 使用**10.0%**

## 💰 开单额度限制
每次最大开单额度: 100.00 USDT (固定值)
- **模式**: 固定值
- **本单最大**: $100.00
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制

---

# 仓位决策框架

## 决策因子

**因子3: 资金管理**
- 资金使用率过高 → 强制减小仓位
- 可用余额不足 → 最小倍数或观望
- 资金充裕 → 可根据信号强度放大
- **⚠️ 额度限制**: 本单最大$100.00，超出部分会被自动裁剪
```

## LLM 决策示例

### 示例 1: LLM 遵守限制

**场景**:
- 可用余额: $1000
- 配置限制: 20% ($200)
- LLM 建议: stake_multiplier = 1.5x

**提示词片段**:
```
本单最大: $200.00
```

**LLM 响应**:
```json
{
    "decision": "adjust",
    "confidence": 0.75,
    "reasoning": "技术信号强劲(RSI超卖+MACD金叉)，波动率正常，建议1.5x仓位。已知额度限制$200。",
    "parameters": {
        "stake_multiplier": 1.5
    }
}
```

**实际执行**:
- 基础仓位: $150
- LLM 调整: $150 × 1.5 = $225
- **应用限制**: $225 → **$200** (被裁剪到最大值)
- 日志: `📊 BTC/USDT 开单额度受限于可用余额的 20%: 225.00 -> 200.00 USDT`

### 示例 2: LLM 自动考虑限制

**场景**:
- 可用余额: $500
- 配置限制: 20% ($100)
- LLM 建议: stake_multiplier = 3.0x

**提示词片段**:
```
本单最大: $100.00
⚠️ 额度限制: 本单最大$100.00，超出部分会被自动裁剪
```

**LLM 响应（智能的 LLM 会考虑限制）**:
```json
{
    "decision": "adjust",
    "confidence": 0.7,
    "reasoning": "强劲突破信号，本应3.0x但考虑到$100限制，实际约2.0x适中。",
    "parameters": {
        "stake_multiplier": 2.0
    }
}
```

**实际执行**:
- 基础仓位: $50
- LLM 调整: $50 × 2.0 = $100
- **未超限**: $100 ≤ $100 ✓
- 最终开单: $100

### 示例 3: 余额不足场景

**场景**:
- 可用余额: $80
- 配置限制: 20% ($16)
- LLM 建议: stake_multiplier = 1.0x

**提示词片段**:
```
可用$80.00 | 使用**84.0%**
本单最大: $16.00
```

**LLM 响应（注意到余额紧张）**:
```json
{
    "decision": "default",
    "confidence": 0.3,
    "reasoning": "信号尚可但资金使用率84%过高，可用仅$80，本单限$16，风险过大建议观望。",
    "parameters": {}
}
```

**实际执行**:
- 使用默认 1.0x
- 可能仍会被限制到 $16

## 配置建议

### 保守策略
```json
{
    "max_stake_per_trade": {
        "mode": "percent",
        "value": 10
    }
}
```
- 每单最多 10% 可用余额
- 至少可以分散到 10 个交易对
- 适合新手或不确定的市场环境

### 平衡策略（推荐）
```json
{
    "max_stake_per_trade": {
        "mode": "percent",
        "value": 20
    }
}
```
- 每单最多 20% 可用余额
- 可以分散到 5 个交易对
- 平衡风险和收益

### 激进策略
```json
{
    "max_stake_per_trade": {
        "mode": "percent",
        "value": 30
    }
}
```
- 每单最多 30% 可用余额
- 适合高置信度信号
- 需要严格的风控

### 固定额度策略
```json
{
    "max_stake_per_trade": {
        "mode": "fixed",
        "value": 100
    }
}
```
- 每单固定最多 $100
- 适合资金量固定的场景
- 风险可控且易于计算

## 总结

开单额度限制功能通过以下方式与 LLM 集成：

1. **显式告知**: 在提示词中明确显示最大额度限制
2. **决策参考**: LLM 在做仓位倍数决策时可以参考这个限制
3. **硬性保障**: 即使 LLM 超出限制，代码层面也会强制裁剪
4. **动态适应**: 百分比模式下，限制会随账户余额动态变化
5. **账户分离**: 自动识别交易方向，使用对应账户的余额计算

这种设计既给了 LLM 充分的决策灵活性，又提供了最后的安全保障。
