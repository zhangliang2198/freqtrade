# 递归分析

本页面解释如何验证你的策略是否因某些指标的递归问题而存在不准确性。

递归公式根据序列的前一项（或多项）定义序列的任何一项。递归公式的一个例子是 a<sub>n</sub> = a<sub>n-1</sub> + b。

为什么这对 Freqtrade 很重要？在回测中，机器人将根据指定的时间范围获取交易对的完整数据。但在模拟/实盘运行中，机器人将受到每个交易所提供的数据量的限制。

例如，要计算一个非常基本的指标叫做 `steps`，第一行的值始终为 0，而后续行的值等于前一行的值加 1。如果我使用最新的 1000 根蜡烛图来计算，那么第一行的 `steps` 值是 0，最后一根已关闭蜡烛图的 `steps` 值是 999。

如果计算仅使用最新的 500 根蜡烛图会发生什么？那么最后一根已关闭蜡烛图的 `steps` 值不是 999，而是 499。值的差异意味着你的回测结果可能与你的模拟/实盘运行结果不同。

`recursive-analysis` 命令需要历史数据才能运行。要了解如何获取你感兴趣的交易对和交易所的数据，请前往文档的[数据下载](data-download.md)部分。

此命令建立在准备不同长度的数据并基于它们计算指标的基础上。
这不会回测策略本身，而只是计算指标。在计算不同启动蜡烛图值（`startup_candle_count`）的指标完成后，会比较所有指定 `startup_candle_count` 的最后一行的值，以查看它们相对于基准计算显示多少差异。

命令设置：

- 使用 `-p` 选项设置你想要分析的交易对。由于我们只查看指标值，使用多个交易对是多余的。最好使用价格相对较高且至少具有中等波动性的交易对，例如 BTC 或 ETH，以避免可能使结果不准确的舍入问题。如果命令中未设置交易对，用于此分析的交易对是白名单中的第一个交易对。
- 建议设置一个长时间范围（至少 5000 根蜡烛图），以便将用作基准的初始指标计算本身具有非常小或没有递归问题。例如，对于 5m 时间框架，5000 根蜡烛图的时间范围将等于 18 天。
- `--cache` 被强制设置为"none"，以避免自动加载先前的指标计算。

除了递归公式检查之外，此命令还对指标值进行简单的前瞻偏差检查。要进行完整的前瞻检查，请使用 [Lookahead-analysis](lookahead-analysis.md)。

## Recursive-analysis 命令参考

--8<-- "commands/recursive-analysis.md"

### 为什么使用奇数作为默认启动蜡烛图？

启动蜡烛图的默认值是奇数。当机器人从交易所的 API 获取蜡烛图数据时，最后一根蜡烛图是机器人正在检查的蜡烛图，其余数据是"启动蜡烛图"。

例如，Binance 每次 API 调用允许 1000 根蜡烛图。当机器人收到 1000 根蜡烛图时，最后一根蜡烛图是"当前蜡烛图"，前面的 999 根蜡烛图是"启动蜡烛图"。通过将启动蜡烛图计数设置为 1000 而不是 999，机器人将尝试获取 1001 根蜡烛图。然后，交易所 API 将以分页形式发送蜡烛图数据，即在 Binance API 的情况下，这将是两组 - 一组长度为 1000，另一组长度为 1。这导致机器人认为策略需要 1001 根蜡烛图的数据，因此它将下载 2000 根蜡烛图的数据，这意味着将有 1 根"当前蜡烛图"和 1999 根"启动蜡烛图"。

此外，交易所限制连续批量 API 调用的次数，例如 Binance 允许 5 次调用。在这种情况下，只能从 Binance API 下载 5000 根蜡烛图而不会达到 API 速率限制，这意味着你可以拥有的最大 `startup_candle_count` 是 4999。

请注意，交易所可能会在未来更改此蜡烛图限制，恕不另行通知。

### 命令如何工作？

- 首先使用提供的时间范围进行初始指标计算，以生成指标值的基准。
- 设置基准后，它将为每个不同的启动蜡烛图计数值执行额外的运行。
- 然后，该命令将比较最后一根蜡烛图行的指标值，并在表中报告差异。

## 了解 recursive-analysis 输出

这是一个输出结果表的示例，其中至少一个指标存在递归公式问题：

```
| indicators   | 20      | 40      | 80     | 100    | 150     | 300     | 999    |
|--------------+---------+---------+--------+--------+---------+---------+--------|
| rsi_30       | nan%    | -6.025% | 0.612% | 0.828% | -0.140% | 0.000%  | 0.000% |
| rsi_14       | 24.141% | -0.876% | 0.070% | 0.007% | -0.000% | -0.000% | -      |
```

列标题表示分析中使用的不同 `startup_candle_count`。表中的值表示计算的指标与基准值相比的差异。

`nan%` 表示由于缺乏数据，无法计算该指标的值。在此示例中，你无法用仅 21 根蜡烛图（1 根当前蜡烛图 + 20 根启动蜡烛图）计算长度为 30 的 RSI。

用户应按指标评估表，以决定指定的 `startup_candle_count` 是否导致足够小的差异，以便指标不会对入场和/或出场产生任何影响。

因此，追求绝对零差异（由 `-` 值显示）可能不是最佳选择，因为某些指标可能需要你使用如此长的 `startup_candle_count` 才能达到零差异。

## 注意事项

- `recursive-analysis` 只会计算并比较最后一行的指标值。输出表报告不同启动蜡烛图计数计算与原始基准计算之间的百分比差异。它是否对你的入场和出场产生任何实际影响不包括在内。
- 理想情况下，指标将没有差异（或至少非常接近 0%），尽管启动蜡烛图发生变化。实际上，EMA 等指标使用递归公式来计算指标值，因此目标不一定是具有零百分比差异，而是使差异足够低（因此 `startup_candle_count` 足够高），以便指标中固有的递归不会对交易决策产生任何实际影响。
- `recursive-analysis` 只会对 `populate_indicators` 和 `@informative` 装饰器运行计算。如果你在 `populate_entry_trend` 或 `populate_exit_trend` 中放置任何指标计算，它将不会被计算。
