# LLM 提示词集成 - 开单额度限制功能

## 完成的工作

已成功将开单额度限制功能集成到 LLM 提示词系统中。

## 修改的文件

### 1. `user_data/llm_deepseek.json`

添加了 `max_stake_per_trade` 配置：

```json
{
    "decision_points": {
        "stake": {
            "max_stake_per_trade": {
                "mode": "percent",
                "value": 5,
                "_comment": "每次开单最多使用可用余额的5%"
            }
        }
    }
}
```

**你已设置为 5%**，这是一个相对保守的配置，适合：
- 至少可以分散到 20 个交易对
- 单笔风险较小
- 适合测试阶段或高波动市场

### 2. `user_data/llm_prompts/stake.j2`

添加了两处改动：

#### 改动 1: 资金状况部分（第 40-52 行）

在"资金状况"部分后添加了开单额度限制的详细信息：

```jinja2
{% if max_stake_per_trade %}
## 💰 开单额度限制
{{ max_stake_per_trade.description }}
{% if max_stake_per_trade.mode == "percent" %}
- **模式**: 百分比 ({{ "%.0f"|format(max_stake_per_trade.percent_value) }}%)
- **当前可用**: ${{ "%.2f"|format(max_stake_per_trade.available_balance) }}
- **本单最大**: ${{ "%.2f"|format(max_stake_per_trade.max_stake_amount) }}
{% else %}
- **模式**: 固定值
- **本单最大**: ${{ "%.2f"|format(max_stake_per_trade.max_stake_amount) }}
{% endif %}
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制
{% endif %}
```

**效果**：LLM 会看到清晰的额度限制信息，例如：
```
## 💰 开单额度限制
每次最大开单额度: 5% 的可用余额 (当前可用: 1000.00, 最大: 50.00)
- **模式**: 百分比 (5%)
- **当前可用**: $1000.00
- **本单最大**: $50.00
⚠️ **重要**: 无论你的仓位倍数决策如何，最终开单金额不会超过此限制
```

#### 改动 2: 决策框架部分（第 107-109 行）

在"因子3: 资金管理"中添加了额度限制提醒：

```jinja2
**因子3: 资金管理**
- 资金使用率过高 → 强制减小仓位
- 可用余额不足 → 最小倍数或观望
- 资金充裕 → 可根据信号强度放大
{% if max_stake_per_trade %}
- **⚠️ 额度限制**: 本单最大${{ "%.2f"|format(max_stake_per_trade.max_stake_amount) }}，超出部分会被自动裁剪
{% endif %}
```

**效果**：在决策框架中再次强调限制，例如：
```
- **⚠️ 额度限制**: 本单最大$50.00，超出部分会被自动裁剪
```

### 3. `user_data/llm_prompts/entry.j2`

**决定不修改**，原因：
- entry 决策点主要关注"是否入场"和"方向选择"
- 仓位大小的决策在 stake 决策点完成
- 在 entry 时还不知道具体的交易方向，无法精确计算额度

## 工作流程

### 完整的决策链路

```
1. Entry 决策点 (entry.j2)
   ↓
   决定: buy / sell / hold
   ↓
2. Stake 决策点 (stake.j2) ← 在这里看到额度限制
   ↓
   决定: stake_multiplier (0.5x - 5.0x)
   LLM 看到: "本单最大 $50.00"
   ↓
3. LLMStrategy.custom_stake_amount()
   ↓
   计算: proposed_stake × stake_multiplier
   ↓
4. 应用 max_stake_per_trade 限制 ← 代码强制执行
   ↓
   如果超出 → 裁剪到最大值
   ↓
5. 最终开单
```

### 示例场景

**场景**:
- 可用余额: $1000
- 配置: 5% ($50)
- 基础仓位: $40
- LLM 建议: 2.0x

**执行过程**:
1. LLM 在 stake.j2 中看到: "本单最大 $50.00"
2. LLM 返回: `stake_multiplier: 2.0`
3. 计算: $40 × 2.0 = $80
4. **应用限制**: $80 → $50 (超出，被裁剪)
5. 日志: `📊 BTC/USDT 开单额度受限于可用余额的 5%: 80.00 -> 50.00 USDT`

## 账户分离模式下的表现

### 多头账户
```
**多头账户**: 初始$5000.00 | 可用$4500.00 | 使用**10.0%**
**空头账户**: 初始$3000.00 | 可用$2800.00 | 使用**6.7%**

## 💰 开单额度限制
每次最大开单额度: 5% 的可用余额 (当前可用: 4500.00, 最大: 225.00)
- **模式**: 百分比 (5%)
- **当前可用**: $4500.00  ← 多头账户的余额
- **本单最大**: $225.00
```

### 空头账户
```
**多头账户**: 初始$5000.00 | 可用$4500.00 | 使用**10.0%**
**空头账户**: 初始$3000.00 | 可用$2800.00 | 使用**6.7%**

## 💰 开单额度限制
每次最大开单额度: 5% 的可用余额 (当前可用: 2800.00, 最大: 140.00)
- **模式**: 百分比 (5%)
- **当前可用**: $2800.00  ← 空头账户的余额
- **本单最大**: $140.00
```

**关键特性**: 自动根据交易方向使用对应账户的余额计算限制

## LLM 的理解和响应

### 聪明的 LLM 会考虑限制

```json
{
    "decision": "adjust",
    "confidence": 0.75,
    "reasoning": "强劲突破+MACD金叉，本应3.0x但考虑$50限制，2.0x即$80仍超限，建议1.5x约$60适中。",
    "parameters": {
        "stake_multiplier": 1.5
    }
}
```

### 即使 LLM 不考虑，代码也会保护

```json
{
    "decision": "adjust",
    "confidence": 0.8,
    "reasoning": "技术信号极强，建议5.0x大仓位。",
    "parameters": {
        "stake_multiplier": 5.0
    }
}
```

**结果**: $40 × 5.0 = $200 → **被裁剪到 $50**

## 配置建议

### 当前配置 (5%)
```json
{
    "max_stake_per_trade": {
        "mode": "percent",
        "value": 5
    }
}
```

**特点**:
- ✅ 极度保守，风险最小
- ✅ 可以分散到 20+ 个交易对
- ✅ 适合测试阶段
- ⚠️ 可能限制收益潜力
- ⚠️ 对于大资金账户，单笔金额可能太小

### 其他常见配置

#### 保守型 (10-15%)
```json
{"mode": "percent", "value": 10}
```
- 至少 10 个交易对
- 适合稳健投资者

#### 平衡型 (15-25%)
```json
{"mode": "percent", "value": 20}
```
- 5-6 个交易对
- 平衡风险和收益
- **推荐配置**

#### 激进型 (25-40%)
```json
{"mode": "percent", "value": 30}
```
- 3-4 个交易对
- 需要对信号有高度信心

#### 固定值（大资金）
```json
{"mode": "fixed", "value": 500}
```
- 每单固定最多 $500
- 适合大资金账户
- 风险固定可控

## 如何调整配置

修改 `user_data/llm_deepseek.json`:

```json
{
    "decision_points": {
        "stake": {
            "max_stake_per_trade": {
                "mode": "percent",  // 或 "fixed"
                "value": 20         // 修改这里
            }
        }
    }
}
```

修改后：
1. 重启策略即可生效
2. 不需要修改提示词模板
3. LLM 会自动看到新的限制

## 验证方法

### 1. 检查日志

启动策略后，查看日志中是否有：

```
📊 BTC/USDT 开单额度受限于可用余额的 5%: 80.00 -> 50.00 USDT
```

### 2. 观察实际开单金额

检查是否有任何开单金额超过配置的最大值。

### 3. 查看 LLM 决策日志

如果启用了 `log_prompts: true`，可以在日志中看到 LLM 收到的完整提示词，确认包含了额度限制信息。

## 文档位置

- **功能说明**: `docs/MAX_STAKE_PER_TRADE.md`
- **提示词示例**: `docs/PROMPT_MAX_STAKE_EXAMPLE.md`
- **实现总结**: `FEATURE_MAX_STAKE_SUMMARY.md`
- **配置示例**: `config_examples/config_llm_max_stake.example.json`
- **测试脚本**: `test_max_stake_feature.py`

## 总结

✅ **已完成**:
1. 配置集成 (`llm_deepseek.json`)
2. 提示词集成 (`stake.j2`)
3. 代码实现（已在前面完成）
4. 测试验证（已通过）
5. 文档编写（已完成）

🎯 **效果**:
- LLM 可以看到并考虑开单额度限制
- 代码层面强制执行限制（双重保险）
- 支持账户分离模式
- 提供清晰的日志输出

📝 **下一步**:
- 启动策略测试实际效果
- 根据实际交易情况调整百分比（当前 5%）
- 观察 LLM 的决策是否考虑了限制
- 监控是否有大量订单被限制裁剪

🚀 **立即可用！**
